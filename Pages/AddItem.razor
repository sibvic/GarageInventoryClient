@page "/projects/{projectId:int}/items/add"

@using System.ComponentModel.DataAnnotations
@inject HttpClient Http
@inject NavigationManager Nav

<PageTitle>Add Item</PageTitle>

<div class="container mt-4">
    <h2 class="mb-3">Add Item to Project @(project?.Name ?? projectId.ToString())</h2>

    <EditForm Model="newItem" OnValidSubmit="CreateItem">
        <DataAnnotationsValidator />
        <ValidationSummary />
        <!-- Name -->
        <div class="mb-3">
            <label class="form-label">Name</label>
            <InputText class="form-control" @bind-Value="newItem.Name" />
            <ValidationMessage For="() => newItem.Name" />
        </div>
        <!-- Manufacturer Number -->
        <div class="mb-3">
            <label class="form-label">Manufacturer #</label>
            <InputText class="form-control" @bind-Value="newItem.ManufacturerNumber" />
        </div>
        <!-- SKU -->
        <div class="mb-3">
            <label class="form-label">SKU</label>
            <InputText class="form-control" @bind-Value="newItem.Sku" />
        </div>
        <!-- In Price -->
        <div class="mb-3">
            <label class="form-label">Purchase Price</label>
            <InputNumber class="form-control" @bind-Value="newItem.InPrice" />
        </div>
        <!-- Out Price -->
        <div class="mb-3">
            <label class="form-label">Sale Price</label>
            <InputNumber class="form-control" @bind-Value="newItem.OutPrice" />
        </div>
        <!-- Status -->
        <div class="mb-3">
            <label class="form-label">Status</label>
            <InputSelect class="form-select" @bind-Value="newItem.Status">
                <option value="">(Select status)</option>
                @foreach (var status in Enum.GetValues(typeof(ItemStatus)))
                {
                    <option value="@(status)">@GetStatusLabel((ItemStatus)status)</option>
                }
            </InputSelect>
        </div>
        <!-- Location -->
        <div class="mb-3">
            <label class="form-label">Location</label>
            <div class="d-flex gap-2">
                <InputSelect class="form-select" @bind-Value="newItem.LocationId">
                    <option value="">(Select location)</option>
                    @if (locations != null)
                    {
                        foreach (var loc in locations)
                        {
                            <option value="@loc.Id">@loc.Name</option>
                        }
                    }
                </InputSelect>
                <button type="button" class="btn btn-outline-secondary" @onclick="() => ToggleAddLocation(true)">+ Add</button>
            </div>
            @if (isAddingLocation)
            {
                <div class="mt-2 d-flex gap-2 align-items-start">
                    <InputText class="form-control" placeholder="New location name" @bind-Value="newLocationName" />
                    <button type="button" class="btn btn-success" disabled="@(isSavingLocation || string.IsNullOrWhiteSpace(newLocationName))" @onclick="AddLocation">Save</button>
                    <button type="button" class="btn btn-link" @onclick="() => ToggleAddLocation(false)">Cancel</button>
                </div>
                @if (!string.IsNullOrEmpty(addLocationError))
                {
                    <div class="text-danger small mt-1">@addLocationError</div>
                }
            }
        </div>
        <!-- Description -->
        <div class="mb-3">
            <label class="form-label">Description</label>
            <InputTextArea class="form-control" @bind-Value="newItem.Description" />
        </div>
        <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Save</button>
            <button type="button" class="btn btn-secondary" @onclick="Cancel">Cancel</button>
        </div>
    </EditForm>
</div>

@code {
    [Parameter]
    public int projectId { get; set; }

    private NewItemDto newItem = new();
    private List<LocationDto>? locations;
    private ProjectDto? project;

    protected override async Task OnInitializedAsync()
    {
        project = await Http.GetFromJsonAsync<ProjectDto>($"/projects/{projectId}");
        locations = await Http.GetFromJsonAsync<List<LocationDto>>("/locations");
        newItem.ProjectId = projectId;
        // Set default status to InStock
        newItem.Status = ItemStatus.InStock;
    }

    private async Task CreateItem()
    {
        // Adjust API route to your backend
        var requestUri = $"/items";
        try
        {
            var response = await Http.PostAsJsonAsync(requestUri, newItem);
            if (response.IsSuccessStatusCode)
            {
                Nav.NavigateTo($"/projects/{projectId}");
            }
            else
            {
                // Minimal UX: stay on page; ideally show error
            }
        }
        catch
        {
            // Minimal UX: stay on page; ideally show error
        }
    }

    private bool isAddingLocation;
    private bool isSavingLocation;
    private string newLocationName = string.Empty;
    private string? addLocationError;

    private void ToggleAddLocation(bool show)
    {
        isAddingLocation = show;
        addLocationError = null;
        if (!show)
        {
            newLocationName = string.Empty;
        }
    }

    private async Task AddLocation()
    {
        addLocationError = null;
        var name = (newLocationName ?? string.Empty).Trim();
        if (string.IsNullOrWhiteSpace(name))
        {
            addLocationError = "Name is required.";
            return;
        }

        try
        {
            isSavingLocation = true;
            var response = await Http.PostAsJsonAsync("/locations", new { name });
            if (!response.IsSuccessStatusCode)
            {
                addLocationError = "Failed to create location.";
                return;
            }

            // Refresh locations and select the newly added one
            locations = await Http.GetFromJsonAsync<List<LocationDto>>("/locations");
            var created = locations?.LastOrDefault(l => string.Equals(l.Name, name, StringComparison.OrdinalIgnoreCase));
            if (created != null)
            {
                newItem.LocationId = created.Id;
            }

            // Reset add UI
            newLocationName = string.Empty;
            isAddingLocation = false;
        }
        catch
        {
            addLocationError = "Error creating location.";
        }
        finally
        {
            isSavingLocation = false;
            StateHasChanged();
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo($"/projects/{projectId}");
    }

    private string GetStatusLabel(ItemStatus status)
    {
        return status switch
        {
            ItemStatus.Sold => "Продано",
            ItemStatus.Used => "Израсходовано",
            ItemStatus.InStock => "В наличии",
            _ => status.ToString()
        };
    }

    public class NewItemDto
    {
        [Required]
        [StringLength(100)]
        public string? Name { get; set; }

        [StringLength(100)]
        public string? ManufacturerNumber { get; set; }

        public int? LocationId { get; set; }

        [StringLength(50)]
        public string? Sku { get; set; }

        public double? InPrice { get; set; }
        public double? OutPrice { get; set; }
        public ItemStatus? Status { get; set; }

        [StringLength(1000)]
        public string? Description { get; set; }

        public int ProjectId { get; set; } // Set in OnInitialized
    }
}
